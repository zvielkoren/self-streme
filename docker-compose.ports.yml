version: "3.8"

# Alternative Docker Compose configuration with port mappings
# Use this if you can't use network_mode: host (e.g., on macOS/Windows Docker Desktop)
#
# Usage: docker-compose -f docker-compose.ports.yml up

services:
  self-streme:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: self-streme
    restart: unless-stopped

    # Port mappings for P2P connectivity
    # BitTorrent/DHT requires UDP ports for peer discovery
    ports:
      - "7000:7000/tcp"      # Application HTTP server
      - "6881:6881/tcp"      # BitTorrent TCP
      - "6881:6881/udp"      # BitTorrent UDP
      - "6882-6889:6882-6889/udp"  # Additional DHT/tracker ports
      # Add more UDP ports if needed: "6890-6900:6890-6900/udp"

    # Environment variables
    environment:
      # Application settings
      - NODE_ENV=production
      - PORT=7000

      # Cloudflare Tunnel Token (optional)
      - TUNNEL_TOKEN=${TUNNEL_TOKEN:-}

      # Torrent configuration - optimize for limited ports
      - TORRENT_TIMEOUT=180000        # 3 minutes timeout
      - TORRENT_MAX_RETRIES=5         # More retries
      - LOG_LEVEL=info

    # Alternative: Load environment variables from .env file
    env_file:
      - .env

    # Volumes for persistent data
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      - ./temp:/app/temp      # Mount temp for torrent downloads

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "1"
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:7000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Sysctls for better networking (Linux only)
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv4.conf.all.forwarding=1

# Optional: Create named volumes for better management
volumes:
  app_data:
  app_logs:
  app_temp:

# Optional: Custom network with specific configuration
networks:
  default:
    name: self-streme-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
