# Maintenance Mode Placeholders

This document describes the placeholder system that Self-Streme uses to provide user-friendly messages when the service is under maintenance.

## Overview

When maintenance mode is enabled, Self-Streme provides visual placeholders instead of error messages to inform users that the service is temporarily unavailable. This creates a better user experience during updates, fixes, or scheduled maintenance.

## Features

### 1. **Streaming Placeholders**
When users try to access streams during maintenance mode, they receive a placeholder stream that displays:
- Current maintenance status
- Estimated completion time (if set)
- Time remaining until service resumes
- Auto-refresh functionality
- Visual status indicators

### 2. **UI Placeholders**
All web endpoints return beautiful, informative maintenance pages with:
- Professional gradient design
- Real-time countdown timer
- Status checking via API
- Automatic page reload when maintenance ends
- Responsive mobile-friendly layout

### 3. **API Responses**
API endpoints return structured JSON responses with:
```json
{
  "error": "Service Unavailable",
  "message": "Custom maintenance message",
  "estimatedEndTime": "2024-01-15T10:00:00Z",
  "timeRemaining": "2 hours 30 minutes",
  "maintenanceMode": true
}
```

## How It Works

### Stream Service Integration

When maintenance mode is enabled, the `StreamService` checks the maintenance status before processing any stream requests:

```javascript
// In src/core/streamService.js
const maintenanceMode = getMaintenanceMode();
if (maintenanceMode.isEnabled()) {
  return this.getMaintenancePlaceholder(maintenanceMode);
}
```

The placeholder stream includes:
- **Name**: "ðŸ”§ Service Under Maintenance"
- **Title**: Includes the maintenance message
- **URL**: Points to `/static/maintenance-placeholder.html`
- **Description**: Shows expected completion time
- **Quality**: "Maintenance"
- **BehaviorHints**: Configured for proper Stremio display

### Middleware Detection

The maintenance middleware automatically detects different request types:

1. **Streaming Requests**: `/stream/*` paths or video file extensions
   - Returns: `maintenance-placeholder.html`
   
2. **API Requests**: `/api/*` paths or `Accept: application/json` header
   - Returns: JSON with 503 status code
   
3. **Browser Requests**: All other paths
   - Returns: Full maintenance page with auto-refresh

### Placeholder Files

#### `/static/maintenance-placeholder.html`
Full-featured maintenance page with:
- Animated icons and status indicators
- Time remaining display
- Auto-refresh countdown (30 seconds)
- Status API polling (every 10 seconds)
- Information about what's happening
- Links to check status via API

#### Generated by `maintenanceMode.generateStreamingPlaceholder()`
Lightweight version optimized for streaming endpoints with:
- Minimal design for fast loading
- Essential information only
- Auto-refresh and status checking
- Optimized for video player embedding

## Usage Examples

### Enabling Maintenance with Placeholders

```bash
# Enable maintenance mode with custom message
curl -X POST http://localhost:7000/api/maintenance/enable \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Upgrading database - streaming will resume shortly",
    "estimatedEndTime": "2024-01-15T10:00:00Z"
  }'
```

### User Experience During Maintenance

1. **Stremio Users**: See maintenance stream in their stream list with clear messaging
2. **Web Users**: Beautiful maintenance page with countdown and auto-refresh
3. **API Clients**: Receive structured JSON response with maintenance details
4. **Mobile Users**: Responsive design works perfectly on all screen sizes

### Automatic Recovery

When maintenance mode ends (manually disabled or scheduled time passes):
- Auto-refresh mechanisms reload pages automatically
- Status polling detects the change within 10 seconds
- Users are seamlessly returned to normal service
- No manual intervention required

## Customization

### Custom Messages

Set a custom maintenance message via environment variable:
```bash
MAINTENANCE_MESSAGE="We're adding new streaming sources. Back in 30 minutes!"
```

Or via API:
```bash
curl -X PUT http://localhost:7000/api/maintenance/update \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Custom message here"
  }'
```

### Styling

The placeholder HTML files use inline CSS with:
- Modern gradients and glassmorphism effects
- Smooth animations and transitions
- Professional color scheme (blue/purple/green)
- Dark theme optimized for streaming services

You can customize the appearance by editing:
- `/src/static/maintenance-placeholder.html` - Full page
- `/src/utils/maintenanceMode.js` - Generated streaming placeholder

### Timing

Configure auto-refresh and polling intervals:

```javascript
// In maintenance-placeholder.html
setTimeout(() => location.reload(), 30000);  // 30 second auto-refresh
setInterval(checkStatus, 10000);             // 10 second status checks
```

## Technical Details

### Stream Placeholder Structure

```javascript
{
  name: "ðŸ”§ Service Under Maintenance",
  title: "ðŸ”§ Service Under Maintenance - [message]",
  url: "/static/maintenance-placeholder.html",
  description: "Self-Streme is currently undergoing maintenance. Expected completion: [time]",
  quality: "Maintenance",
  size: "N/A",
  seeders: 0,
  source: "maintenance",
  behaviorHints: {
    notWebReady: false,
    bingeGroup: "self-streme-maintenance"
  }
}
```

### Request Flow

```
User Request
    â†“
Maintenance Middleware Check
    â†“
Is Maintenance Enabled? â†’ No â†’ Continue to Normal Processing
    â†“ Yes
Is Whitelisted IP? â†’ Yes â†’ Continue to Normal Processing
    â†“ No
Has Bypass Token? â†’ Yes â†’ Continue to Normal Processing
    â†“ No
Detect Request Type
    â”œâ”€ Streaming Request â†’ Return maintenance-placeholder.html
    â”œâ”€ API Request â†’ Return JSON 503 response
    â””â”€ Browser Request â†’ Return full maintenance page
```

### Caching

Placeholder responses include cache control headers:
```http
Cache-Control: no-cache
Content-Type: text/html; charset=utf-8
```

This ensures users always see the latest status and don't receive cached outdated information.

## Best Practices

### 1. **Set Realistic Time Estimates**
Always provide an `estimatedEndTime` when enabling maintenance mode:
```bash
# Good: Specific end time
-d '{"estimatedEndTime": "2024-01-15T10:30:00Z"}'

# Less helpful: No end time
-d '{}'
```

### 2. **Use Clear Messages**
Write messages that explain what's happening:
```bash
# Good: Specific and helpful
"Upgrading to v2.0 - new features and better performance"

# Less helpful: Vague
"Service down"
```

### 3. **Test Before Production**
Test maintenance mode on staging first:
```bash
# Enable maintenance
curl -X POST http://staging.example.com/api/maintenance/enable ...

# Verify placeholders appear correctly
# Test auto-refresh functionality
# Check API responses

# Disable maintenance
curl -X POST http://staging.example.com/api/maintenance/disable ...
```

### 4. **Monitor Auto-Disable**
If you set an `estimatedEndTime`, the system will auto-disable maintenance when that time passes. Monitor logs to confirm:
```
[Maintenance] Scheduled maintenance window has passed, auto-disabling
[Maintenance] DISABLED - Service is now available
```

### 5. **Whitelist Admin IPs**
Ensure your admin IPs are whitelisted so you can verify the service works during maintenance:
```bash
MAINTENANCE_WHITELIST_IPS="192.168.1.100,10.0.0.50"
```

## Troubleshooting

### Placeholders Not Showing

**Problem**: Users still see errors instead of maintenance placeholders

**Solutions**:
1. Verify maintenance mode is enabled:
   ```bash
   curl http://localhost:7000/api/maintenance/status
   ```

2. Check maintenance middleware is active in `src/index.js`:
   ```javascript
   app.use(maintenanceMode.middleware());
   ```

3. Ensure placeholder files exist:
   ```bash
   ls src/static/maintenance-placeholder.html
   ```

### Auto-Refresh Not Working

**Problem**: Page doesn't automatically refresh when maintenance ends

**Solutions**:
1. Check browser console for JavaScript errors
2. Verify status endpoint is accessible: `/api/maintenance/status`
3. Ensure no Content Security Policy blocking fetch requests
4. Check browser doesn't have auto-refresh disabled

### Stremio Shows Error Instead of Placeholder

**Problem**: Stremio displays error message instead of maintenance placeholder

**Solutions**:
1. Verify `getMaintenancePlaceholder()` returns valid stream structure
2. Check stream service integration in `src/core/streamService.js`
3. Ensure placeholder URL is accessible: `/static/maintenance-placeholder.html`
4. Test stream response format matches Stremio requirements

## See Also

- [MAINTENANCE_MODE.md](./MAINTENANCE_MODE.md) - Complete maintenance mode guide
- [MAINTENANCE_MODE_QUICK.md](../MAINTENANCE_MODE_QUICK.md) - Quick reference
- [MAINTENANCE_MODE_IMPLEMENTATION.md](./MAINTENANCE_MODE_IMPLEMENTATION.md) - Implementation details

## Files

- `src/utils/maintenanceMode.js` - Core maintenance mode logic and placeholder generation
- `src/static/maintenance-placeholder.html` - Full maintenance page
- `src/core/streamService.js` - Stream placeholder integration
- `src/index.js` - Middleware integration and static file serving